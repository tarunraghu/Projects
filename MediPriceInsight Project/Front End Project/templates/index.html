<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Data Explorer</title>
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include jQuery UI -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <!-- Add Select2 CSS and JS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Add Chart.js for histograms -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #6a1b9a;
            --primary-light: #9c4dcc;
            --primary-dark: #38006b;
            --secondary-color: #f3e5f5;
            --text-color: #333;
            --border-color: #e0e0e0;
            --background-color: #fafafa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .form-container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            max-width: 1800px;
            width: 100%;
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: 600;
        }

        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
            max-width: 300px;
        }

        .optional-filters {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            border: 1px solid var(--border-color);
            max-width: 1800px;
            width: 100%;
        }

        .optional-filters h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-dark);
            font-size: 1.2em;
            font-weight: 500;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-dark);
        }

        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            background-color: white;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-light);
        }

        .ui-autocomplete {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            border-radius: 6px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .ui-menu-item {
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .ui-menu-item:hover {
            background-color: var(--secondary-color);
        }

        .report-button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 25px;
            font-weight: 600;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .report-button:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .report-button:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
            transform: none;
        }

        .flash-messages {
            margin-bottom: 25px;
        }

        .flash-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .flash-error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .flash-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: normal;
            word-wrap: break-word;
        }
        /* Specific column widths for readability */
        .data-table th:nth-child(1), .data-table td:nth-child(1) { width: 220px; min-width: 220px; max-width: 220px; } /* Hospital Name */
        .data-table th:nth-child(2), .data-table td:nth-child(2) { width: 90px; min-width: 90px; max-width: 90px; }   /* Code */
        .data-table th:nth-child(3), .data-table td:nth-child(3) { width: 250px; min-width: 250px; max-width: 250px; } /* Description */
        .data-table th:nth-child(4), .data-table td:nth-child(4) { width: 120px; min-width: 120px; max-width: 120px; } /* City */
        .data-table th:nth-child(5), .data-table td:nth-child(5) { width: 120px; min-width: 120px; max-width: 120px; } /* Region */
        .data-table th:nth-child(6), .data-table td:nth-child(6) { width: 150px; min-width: 150px; max-width: 150px; } /* Payer Name */
        .data-table th:nth-child(7), .data-table td:nth-child(7) { width: 150px; min-width: 150px; max-width: 150px; } /* Plan Name */
        .data-table th:nth-child(8), .data-table td:nth-child(8) { width: 120px; min-width: 120px; max-width: 120px; } /* Min Charge */
        .data-table th:nth-child(9), .data-table td:nth-child(9) { width: 120px; min-width: 120px; max-width: 120px; } /* Max Charge */
        .data-table th:nth-child(10), .data-table td:nth-child(10) { width: 120px; min-width: 120px; max-width: 120px; } /* Gross Charge */
        .data-table th:nth-child(11), .data-table td:nth-child(11) { width: 90px; min-width: 90px; max-width: 90px; } /* Negotiated Charge */
        /* Zebra striping for rows */
        .data-table tr:nth-child(even) {
            background-color: #f3e5f5;
        }
        .data-table tr:nth-child(odd) {
            background-color: #fff;
        }
        .data-table th, .data-table td {
            border-right: 1px solid #e0e0e0;
        }
        .data-table th:last-child, .data-table td:last-child {
            border-right: none;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: rgba(106, 27, 154, 0.05);
        }

        #loading {
            display: none;
            text-align: center;
            padding: 30px;
            color: var(--primary-color);
            font-size: 18px;
        }

        #error-message {
            display: none;
            color: #c62828;
            padding: 15px;
            margin: 15px 0;
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 6px;
            font-weight: 500;
        }

        .active-filters {
            margin-top: 20px;
            font-size: 0.9em;
        }

        .filter-tag {
            display: inline-block;
            background-color: var(--primary-light);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            margin-right: 10px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .search-help {
            font-size: 0.85em;
            color: #666;
            margin-top: 6px;
            font-style: italic;
        }

        .required {
            color: #c62828;
            font-weight: bold;
        }

        /* Add loading indicator styles */
        .ui-autocomplete-loading {
            background: white url('https://jqueryui.com/resources/demos/autocomplete/images/ui-anim_basic_16x16.gif') right center no-repeat;
            background-size: 16px 16px;
        }

        .ui-menu-item div {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Loading screen styles */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--primary-light);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: var(--primary-color);
            font-size: 18px;
            font-weight: 500;
        }

        .loading-progress {
            margin-top: 10px;
            color: var(--text-color);
            font-size: 14px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .main-content {
            display: none;
        }

        /* Add CSS for checkboxes in Select2 */
        .select2-results__option .checkbox {
            margin-right: 8px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            padding-left: 24px;
            position: relative;
        }

        .data-table tbody {
            display: block;
            max-height: 500px;
            height: 500px;
            overflow-y: auto;
            width: 100%;
        }
        .data-table thead, .data-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        .data-table th, .data-table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table th .sort-btn {
            color: #fff !important;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 4px;
            font-size: 16px;
        }
        .data-table th span {
            color: #fff !important;
        }

        .data-table-wrapper {
            width: 100%;
            overflow-x: auto;
            overflow-y: auto;
            max-width: 100vw;
            margin: 0 auto;
            max-height: 600px;
        }
        .data-table {
            width: max-content;
            min-width: 1550px;
            border-collapse: collapse;
            border-spacing: 0;
        }
        .data-table tbody {
            display: block;
            max-height: 500px;
            overflow-y: auto;
            width: 100%;
        }
        .data-table thead, .data-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: normal;
            word-wrap: break-word;
        }

        /* Add/replace CSS for new filter layout */
        .filter-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 10px; }
        .filter-group { min-width: 200px; flex: 1; }
        .active-filters { margin: 10px 0; }
        .filter-chip {
            display: inline-block; background: #9c4dcc; color: #fff; border-radius: 16px;
            padding: 4px 12px; margin-right: 8px; margin-bottom: 5px; font-size: 0.95em;
        }
        .filter-chip .remove-chip { margin-left: 8px; cursor: pointer; font-weight: bold; }
        .reset-btn { background: #6a1b9a; color: #fff; border: none; border-radius: 16px; padding: 6px 18px; cursor: pointer; }

        .active-filters-bar {
            background: #f3e5f5;
            border-radius: 20px;
            padding: 10px 18px;
            margin: 10px 0 18px 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            min-height: 40px;
        }
        .filter-chip {
            display: inline-flex;
            align-items: center;
            background: #9c4dcc;
            color: #fff;
            border-radius: 16px;
            padding: 4px 12px;
            margin-right: 4px;
            margin-bottom: 4px;
            font-size: 1em;
        }
        .filter-chip .remove-chip {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Hospital Data Explorer</div>
        <div class="loading-progress">Initializing...</div>
    </div>

    <!-- Main Content (initially hidden) -->
    <div class="main-content">
        <div class="form-container">
            <h2>Hospital Data Explorer</h2>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
                {% endif %}
            {% endwith %}

            <div class="filter-row">
                <div class="filter-group">
                    <label for="code">Code(s): <span class="required">*</span></label>
                    <select id="code" name="code" multiple style="width: 100%"></select>
                </div>
                <div class="filter-group">
                    <label for="region">Region(s):</label>
                    <select id="region" name="region" multiple style="width: 100%"></select>
                </div>
                <div class="filter-group">
                    <label for="city">City/Cities:</label>
                    <select id="city" name="city" multiple style="width: 100%"></select>
                </div>
                <div class="filter-group">
                    <label for="payer_name">Payer Name:</label>
                    <select id="payer_name" name="payer_name" multiple style="width: 100%"></select>
                </div>
                <div class="filter-group">
                    <label for="plan_name">Plan Name:</label>
                    <select id="plan_name" name="plan_name" multiple style="width: 100%"></select>
                </div>
            </div>
            <div class="active-filters-bar" id="active-filters"></div>
            <button class="reset-btn" id="reset-filters">Reset All</button>
        </div>

        <div id="loading">Loading data...</div>
        <div id="error-message"></div>
        <div id="data-container">
            <div class="data-table-wrapper">
                <table class="data-table" id="hospital-data" style="display: none;">
                    <thead>
                        <tr id="table-headers"></tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let currentRequest = null;
            let codeOptions = [];
            let regionOptions = [];
            let cityOptions = [];
            let chartObjects = {};
            let currentSort = { column: null, direction: 'asc' };
            let visibleChargeColumns = [];

            // Add CSS for checkboxes in Select2
            const style = document.createElement('style');
            style.innerHTML = `
            .select2-results__option .checkbox {
                margin-right: 8px;
            }
            .select2-container--default .select2-selection--multiple .select2-selection__choice {
                padding-left: 24px;
                position: relative;
            }
            `;
            document.head.appendChild(style);

            // Only use formatOptionWithCheckbox for Select2 dropdowns (code, region, city, payer_name, plan_name)
            function formatOptionWithCheckbox(option) {
                if (!option.id) return option.text;
                const checked = $(option.element).prop('selected');
                const $container = $('<span></span>');
                $container.append(
                    $('<input type="checkbox" class="checkbox" style="pointer-events:none; margin-right:8px;">').prop('checked', checked)
                );
                $container.append(option.text);
                return $container;
            }

            // Initialize Select2 for all multi-selects
            $('#code').select2({
                placeholder: "Select code(s)",
                allowClear: true,
                closeOnSelect: false,
                templateResult: formatOptionWithCheckbox,
                templateSelection: function(selection) {
                    return selection.length > 0 ? selection.map(s => s.text).join(', ') : '';
                }
            });
            $('#region').select2({
                placeholder: "Select region(s)",
                allowClear: true,
                closeOnSelect: false,
                templateResult: formatOptionWithCheckbox,
                templateSelection: function(selection) {
                    return selection.length > 0 ? selection.map(s => s.text).join(', ') : '';
                }
            });
            $('#city').select2({
                placeholder: "Select city/cities",
                allowClear: true,
                closeOnSelect: false,
                templateResult: formatOptionWithCheckbox,
                templateSelection: function(selection) {
                    return selection.length > 0 ? selection.map(s => s.text).join(', ') : '';
                }
            });
            $('#payer_name').select2({
                placeholder: "Select payer name(s)",
                allowClear: true,
                closeOnSelect: false,
                templateResult: formatOptionWithCheckbox,
                templateSelection: function(selection) {
                    return selection.length > 0 ? selection.map(s => s.text).join(', ') : '';
                }
            });
            $('#plan_name').select2({
                placeholder: "Select plan name(s)",
                allowClear: true,
                closeOnSelect: false,
                templateResult: formatOptionWithCheckbox,
                templateSelection: function(selection) {
                    return selection.length > 0 ? selection.map(s => s.text).join(', ') : '';
                }
            });

            // Handle 'All' logic for each filter
            function handleAllLogic(selector) {
                $(selector).on('select2:select', function(e) {
                    if (e.params.data.id === 'all') {
                        $(selector).val(['all']).trigger('change.select2');
                    } else {
                        let vals = $(selector).val().filter(v => v !== 'all');
                        $(selector).val(vals).trigger('change.select2');
                    }
                });
            }
            handleAllLogic('#region');
            handleAllLogic('#city');
            handleAllLogic('#payer_name');
            handleAllLogic('#plan_name');

            // Function to load all initial data
            function loadInitialData() {
                return new Promise((resolve, reject) => {
                    $('#loading-screen').show();
                    $('.main-content').hide();
                    $.get('/api/initial-data')
                        .done(function(data) {
                            // Populate code multi-select
                            codeOptions = data.codes_and_descriptions.map(item => ({id: item.code, text: `${item.code} - ${item.description}`}));
                            $('#code').empty();
                            codeOptions.forEach(opt => $('#code').append(new Option(opt.text, opt.id)));
                            // Populate region multi-select
                            regionOptions = data.regions;
                            $('#region').empty();
                            regionOptions.forEach(region => $('#region').append(new Option(region, region)));
                            // Populate city multi-select
                            cityOptions = data.cities;
                            $('#city').empty();
                            cityOptions.forEach(city => $('#city').append(new Option(city, city)));
                            // Populate payer_name multi-select
                            $('#payer_name').empty();
                            if (data.payer_names) {
                                data.payer_names.forEach(payer => $('#payer_name').append(new Option(payer, payer)));
                            }
                            // Populate plan_name multi-select
                            $('#plan_name').empty();
                            if (data.plan_names) {
                                data.plan_names.forEach(plan => $('#plan_name').append(new Option(plan, plan)));
                            }
                            setTimeout(() => {
                                $('#loading-screen').fadeOut(500, function() {
                                    $('.main-content').fadeIn(500);
                                });
                            }, 500);
                            resolve();
                        })
                        .fail(function(error) {
                            $('.loading-text').text('Error loading data. Please refresh the page.');
                            $('.loading-progress').text('Error: ' + error.statusText);
                            reject(error);
                        });
                });
            }

            // Load data when document is ready
            loadInitialData().then(function() {
                fetchData();
            }).catch(function(error) {
                console.error('Failed to load initial data:', error);
            });

            // Function to update active filters display
            function updateActiveFilters() {
                const activeFilters = [];
                const code = $('#code').val();
                const region = $('#region').val();
                const city = $('#city').val();
                const payerNames = $('#payer_name').val();
                const planNames = $('#plan_name').val();

                function getLabel(selector, value) {
                    const opt = $(`${selector} option[value='${value.replace(/'/g, "\\'") }']`);
                    if (opt.length && opt.text().toLowerCase().includes('loading')) {
                        return null; // skip loading options
                    }
                    return opt.length ? opt.text() : value;
                }

                if (code && code.length > 0) {
                    code.forEach(c => {
                        if (c === 'all') {
                            activeFilters.push({type: 'Code', value: 'All'});
                        } else {
                            const label = getLabel('#code', c);
                            if (label) activeFilters.push({type: 'Code', value: label});
                        }
                    });
                }
                if (region && region.length > 0) {
                    region.forEach(r => {
                        if (r === 'all') {
                            activeFilters.push({type: 'Region', value: 'All'});
                        } else {
                            const label = getLabel('#region', r);
                            if (label) activeFilters.push({type: 'Region', value: label});
                        }
                    });
                }
                if (city && city.length > 0) {
                    city.forEach(c => {
                        if (c === 'all') {
                            activeFilters.push({type: 'City', value: 'All'});
                        } else {
                            const label = getLabel('#city', c);
                            if (label) activeFilters.push({type: 'City', value: label});
                        }
                    });
                }
                if (payerNames && payerNames.length > 0) {
                    payerNames.forEach(p => {
                        if (p === 'all') {
                            activeFilters.push({type: 'Payer Name', value: 'All'});
                        } else {
                            const label = getLabel('#payer_name', p);
                            if (label) activeFilters.push({type: 'Payer Name', value: label});
                        }
                    });
                }
                if (planNames && planNames.length > 0) {
                    planNames.forEach(p => {
                        if (p === 'all') {
                            activeFilters.push({type: 'Plan Name', value: 'All'});
                        } else {
                            const label = getLabel('#plan_name', p);
                            if (label) activeFilters.push({type: 'Plan Name', value: label});
                        }
                    });
                }

                const container = $('#active-filters');
                container.empty();
                activeFilters.forEach(filter => {
                    const chip = $(`<span class="filter-chip">${filter.type}: ${filter.value} <span class="remove-chip" data-type="${filter.type.toLowerCase().replace(' ', '_')}" data-value="${filter.value}">&times;</span></span>`);
                    container.append(chip);
                });
            }

            // Remove a filter when chip is clicked
            $(document).on('click', '.remove-chip', function() {
                const type = $(this).data('type');
                const value = $(this).data('value');
                const $select = $('#' + type);
                let vals = $select.val() || [];
                vals = vals.filter(v => v !== value);
                $select.val(vals).trigger('change.select2');
                updateCascadingFilters();
                fetchData();
            });

            // Reset all filters
            $('#reset-filters').on('click', function() {
                $('#code').val(null).trigger('change.select2');
                $('#region').val(null).trigger('change.select2');
                $('#city').val(null).trigger('change.select2');
                $('#payer_name').val(null).trigger('change.select2');
                $('#plan_name').val(null).trigger('change.select2');
                updateCascadingFilters();
                fetchData();
            });

            // User-friendly column name mapping
            const COLUMN_DISPLAY_NAMES = {
                hospital_name: 'Hospital Name',
                code: 'Code',
                description: 'Description',
                city: 'City',
                region: 'Region',
                payer_name: 'Payer Name',
                plan_name: 'Plan Name',
                standard_charge_min: 'Min Charge',
                standard_charge_max: 'Max Charge',
                standard_charge_gross: 'Gross Charge',
                standard_charge_negotiated_dollar: 'Negotiated Charge'
            };

            // Function to fetch and display data
            function fetchData() {
                const codes = $('#code').val();
                const regions = $('#region').val();
                const cities = $('#city').val();
                const payerNames = $('#payer_name').val();
                const planNames = $('#plan_name').val();
                // Codes is mandatory
                if (!codes || codes.length === 0) {
                    // Hide table and show a message
                    document.getElementById('hospital-data').style.display = 'none';
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('error-message').textContent = 'Please select at least one code to view data.';
                    return;
                }
                if (currentRequest) currentRequest.abort();
                const params = new URLSearchParams();
                codes && codes.forEach(c => params.append('code', c));
                regions && regions.forEach(r => params.append('region', r));
                cities && cities.forEach(c => params.append('city', c));
                payerNames && payerNames.forEach(p => params.append('payer_name', p));
                planNames && planNames.forEach(p => params.append('plan_name', p));
                const table = document.getElementById('hospital-data');
                const loading = document.getElementById('loading');
                const errorMessage = document.getElementById('error-message');
                loading.style.display = 'block';
                errorMessage.style.display = 'none';
                currentRequest = $.ajax({
                    url: `/get_data?${params.toString()}`,
                    method: 'GET',
                    success: function(data) {
                        if (data.error) throw new Error(data.error);
                        // Clear existing table content
                        const headerRow = document.getElementById('table-headers');
                        const tableBody = document.getElementById('table-body');
                        headerRow.innerHTML = '';
                        tableBody.innerHTML = '';
                        // Add headers
                        const filteredColumns = data.columns.filter(col => col !== 'id');
                        filteredColumns.forEach(column => {
                            const th = document.createElement('th');
                            th.style.cursor = 'pointer';
                            let displayName = COLUMN_DISPLAY_NAMES[column] || column;
                            let sortArrow = '';
                            if (currentSort.column === column) {
                                sortArrow = currentSort.direction === 'asc' ? ' \u25B2' : ' \u25BC';
                            }
                            th.innerHTML = `<span>${displayName}${sortArrow}</span> <button class="sort-btn" data-col="${column}" style="background:none;border:none;cursor:pointer;padding:0 4px;">⇅</button>`;
                            headerRow.appendChild(th);
                        });
                        // Add event listener for sort buttons after rendering headers
                        Array.from(headerRow.querySelectorAll('.sort-btn')).forEach(btn => {
                            btn.onclick = function(e) {
                                const col = btn.getAttribute('data-col');
                                if (currentSort.column === col) {
                                    if (currentSort.direction === 'asc') {
                                        currentSort.direction = 'desc';
                                    } else if (currentSort.direction === 'desc') {
                                        currentSort.column = null;
                                        currentSort.direction = null;
                                    }
                                } else {
                                    currentSort.column = col;
                                    currentSort.direction = 'asc';
                                }
                                renderTableRows(filteredColumns, data.data);
                                renderTableHeaders(filteredColumns);
                            };
                        });
                        // Helper to render table rows with sorting
                        function renderTableRows(columns, rows) {
                            const tableBody = document.getElementById('table-body');
                            tableBody.innerHTML = '';
                            let sortedRows = [...rows];
                            if (currentSort.column) {
                                sortedRows.sort((a, b) => {
                                    let v1 = a[currentSort.column];
                                    let v2 = b[currentSort.column];
                                    // Handle null/undefined values
                                    if (v1 === null || v1 === undefined) v1 = '';
                                    if (v2 === null || v2 === undefined) v2 = '';
                                    // Convert to string for comparison
                                    v1 = v1.toString().toLowerCase();
                                    v2 = v2.toString().toLowerCase();
                                    // Try to convert to numbers if possible
                                    const num1 = parseFloat(v1);
                                    const num2 = parseFloat(v2);
                                    if (!isNaN(num1) && !isNaN(num2)) {
                                        // Both values are numbers
                                        return currentSort.direction === 'asc' ? num1 - num2 : num2 - num1;
                                    } else {
                                        // At least one value is not a number, do string comparison
                                        if (v1 < v2) return currentSort.direction === 'asc' ? -1 : 1;
                                        if (v1 > v2) return currentSort.direction === 'asc' ? 1 : -1;
                                        return 0;
                                    }
                                });
                            }
                            sortedRows.slice(0, 100).forEach(row => {
                                const tr = document.createElement('tr');
                                columns.forEach(column => {
                                    const td = document.createElement('td');
                                    td.textContent = row[column] || '';
                                    tr.appendChild(td);
                                });
                                tableBody.appendChild(tr);
                            });
                        }
                        // Helper to render table headers (for sort arrow update)
                        function renderTableHeaders(columns) {
                            const headerRow = document.getElementById('table-headers');
                            headerRow.innerHTML = '';
                            columns.forEach(column => {
                                const th = document.createElement('th');
                                th.style.cursor = 'pointer';
                                let displayName = COLUMN_DISPLAY_NAMES[column] || column;
                                let sortArrow = '';
                                if (currentSort.column === column) {
                                    sortArrow = currentSort.direction === 'asc' ? ' \u25B2' : ' \u25BC';
                                }
                                th.innerHTML = `<span>${displayName}${sortArrow}</span> <button class="sort-btn" data-col="${column}" style="background:none;border:none;cursor:pointer;padding:0 4px;">⇅</button>`;
                                headerRow.appendChild(th);
                            });
                            Array.from(headerRow.querySelectorAll('.sort-btn')).forEach(btn => {
                                btn.onclick = function(e) {
                                    const col = btn.getAttribute('data-col');
                                    if (currentSort.column === col) {
                                        if (currentSort.direction === 'asc') {
                                            currentSort.direction = 'desc';
                                        } else if (currentSort.direction === 'desc') {
                                            currentSort.column = null;
                                            currentSort.direction = null;
                                        }
                                    } else {
                                        currentSort.column = col;
                                        currentSort.direction = 'asc';
                                    }
                                    renderTableRows(filteredColumns, data.data);
                                    renderTableHeaders(filteredColumns);
                                };
                            });
                        }
                        // In fetchData, after data is loaded:
                        fetchData.lastData = data;
                        renderTableRows(filteredColumns, data.data);
                        renderTableHeaders(filteredColumns);
                        // Always show table, hide loading
                        table.style.display = 'table';
                        loading.style.display = 'none';
                        updateActiveFilters();
                    },
                    error: function(xhr, status, error) {
                        if (status !== 'abort') {
                            errorMessage.textContent = 'Error loading data: ' + error;
                            errorMessage.style.display = 'block';
                            loading.style.display = 'none';
                        }
                    },
                    complete: function() { currentRequest = null; }
                });
            }

            // Debounce utility
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            // Show loading in dropdowns
            function setDropdownLoading(selector) {
                $(selector).empty().append(new Option('Loading...', '', true, true)).trigger('change.select2');
                $(selector).prop('disabled', true);
            }
            function unsetDropdownLoading(selector) {
                $(selector).prop('disabled', false);
            }

            // Debounced version of updateCascadingFilters
            const debouncedUpdateCascadingFilters = debounce(function() {
                setDropdownLoading('#region');
                setDropdownLoading('#city');
                setDropdownLoading('#payer_name');
                setDropdownLoading('#plan_name');
                updateCascadingFilters();
            }, 250);

            // On region change, show loading in city dropdown immediately
            $('#region').on('change', function() {
                setDropdownLoading('#city');
                setDropdownLoading('#payer_name');
                setDropdownLoading('#plan_name');
                debouncedUpdateCascadingFilters();
                fetchData();
            });
            // On city change, show loading in payer_name and plan_name immediately
            $('#city').on('change', function() {
                setDropdownLoading('#payer_name');
                setDropdownLoading('#plan_name');
                debouncedUpdateCascadingFilters();
                fetchData();
            });
            // On payer_name change, show loading in plan_name immediately
            $('#payer_name').on('change', function() {
                setDropdownLoading('#plan_name');
                debouncedUpdateCascadingFilters();
                fetchData();
            });
            // On plan_name change, just update as usual
            $('#plan_name').on('change', function() {
                debouncedUpdateCascadingFilters();
                fetchData();
            });
            // On code change, show loading in all dependent dropdowns immediately
            $('#code').on('change', function() {
                setDropdownLoading('#region');
                setDropdownLoading('#city');
                setDropdownLoading('#payer_name');
                setDropdownLoading('#plan_name');
                debouncedUpdateCascadingFilters();
                fetchData();
            });

            // In updateCascadingFilters(), after updating each dropdown, call unsetDropdownLoading(selector)
            function updateCascadingFilters() {
                const codes = $('#code').val() || [];
                const regions = $('#region').val() || [];
                const cities = $('#city').val() || [];
                const payerNames = $('#payer_name').val() || [];
                const planNames = $('#plan_name').val() || [];
                const params = new URLSearchParams();
                codes.forEach(c => params.append('code', c));
                regions.forEach(r => params.append('region', r));
                cities.forEach(c => params.append('city', c));
                payerNames.forEach(p => params.append('payer_name', p));
                planNames.forEach(p => params.append('plan_name', p));
                $.get('/api/filter-options?' + params.toString(), function(data) {
                    // Update Region(s)
                    const prevRegions = $('#region').val() || [];
                    $('#region').empty();
                    $('#region').append(new Option('All', 'all'));
                    data.regions.forEach(region => {
                        $('#region').append(new Option(`${region.name} (${region.count})`, region.name));
                    });
                    const regionNames = data.regions.map(r => r.name);
                    $('#region').val(prevRegions.filter(r => r === 'all' || regionNames.includes(r)));
                    unsetDropdownLoading('#region');
                    $('#region').trigger('change.select2');
                    // Update City/Cities
                    $('#city').empty();
                    $('#city').append(new Option('All', 'all'));
                    data.cities.forEach(city => {
                        $('#city').append(new Option(`${city.name} (${city.count})`, city.name));
                    });
                    console.log('Cities added to dropdown:', data.cities.map(city => city.name));
                    const cityNames = data.cities.map(c => c.name);
                    const prevCities = $('#city').val() || [];
                    $('#city').val(prevCities.filter(c => c === 'all' || cityNames.includes(c)));
                    unsetDropdownLoading('#city');
                    $('#city').trigger('change.select2');
                    // Update Payer Name
                    const prevPayers = $('#payer_name').val() || [];
                    $('#payer_name').empty();
                    $('#payer_name').append(new Option('All', 'all'));
                    data.payer_names.forEach(payer => {
                        $('#payer_name').append(new Option(`${payer.name} (${payer.count})`, payer.name));
                    });
                    const payerNamesList = data.payer_names.map(p => p.name);
                    $('#payer_name').val(prevPayers.filter(p => p === 'all' || payerNamesList.includes(p)));
                    unsetDropdownLoading('#payer_name');
                    $('#payer_name').trigger('change.select2');
                    // Update Plan Name
                    const prevPlans = $('#plan_name').val() || [];
                    $('#plan_name').empty();
                    $('#plan_name').append(new Option('All', 'all'));
                    data.plan_names.forEach(plan => {
                        $('#plan_name').append(new Option(`${plan.name} (${plan.count})`, plan.name));
                    });
                    const planNamesList = data.plan_names.map(p => p.name);
                    $('#plan_name').val(prevPlans.filter(p => p === 'all' || planNamesList.includes(p)));
                    unsetDropdownLoading('#plan_name');
                    $('#plan_name').trigger('change.select2');
                });
            }

            // In JS, track which charge columns are selected
            $('.charge-col-toggle').on('change', function() {
                visibleChargeColumns = $('.charge-col-toggle:checked').map(function() { return this.value; }).get();
                fetchData();
            });
        });
    </script>
</body>
</html> 